<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Loan Chatbot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#eef3f7; margin:0; padding:0; }

    /* ------------------ NAVBAR ------------------ */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 14px 0;
      background: linear-gradient(90deg, #0066ff, #00a2ff);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      text-align: center;
      z-index: 999;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 25px;
      font-size: 20px;
      font-weight: bold;
    }

    /* ------------------ Chatbox ------------------ */
  .container { 
  max-width:800px; 
  margin:120px auto 0;           /* remove bottom margin */
  height: calc(100vh - 120px);   /* FULL HEIGHT except navbar */
  background:white; 
  border-radius:8px; 
  box-shadow:0 6px 20px rgba(0,0,0,0.08); 
  display:flex;
  flex-direction:column;
  overflow:hidden; 
}
 
}


    }

    header { 
      background: linear-gradient(90deg,#0066ff,#00a2ff); 
      color:#fff; padding:14px 20px; 
    }
    header h1 { margin:0; font-size:20px; }

    .chat-window { 
  flex:1;                 /* take full remaining height */
  overflow-y:auto; 
  padding:20px; 
  background:#f7fbff;
}


    .message { 
      max-width:78%; 
      margin-bottom:12px; 
      padding:12px 14px; 
      border-radius:12px; 
      line-height:1.4; 
      word-wrap: break-word;
    }
    .assistant { background:#ffffff; box-shadow:0 2px 8px rgba(0,0,0,0.06); float:left; clear:both; }
    .user { background: #dff6ff; float:right; clear:both; }

    .composer { 
      display:flex; padding:14px; 
      border-top:1px solid #eee; 
      background:#fff; 
    }
    .composer input { 
      flex:1; padding:10px 12px; 
      border-radius:8px; border:1px solid #ddd; 
      font-size:15px; 
    }
    .composer button { 
      margin-left:10px; padding:10px 16px; 
      background:#0066ff; color:white; 
      border:none; border-radius:8px; cursor:pointer; 
    }
    .clear { clear:both; }
    .meta { font-size:12px; color:#666; margin-bottom:8px; }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav>
  <a href="/">Home</a>
  <a href="/about">About Us</a>
  <a href="/prediction">Prediction</a>
  <a href="/chatbot">Chatbot</a>
</nav>

<div class="container">
    <header>
      <h1>ðŸ¤– Loan Eligibility Chatbot</h1>
    </header>

    <div id="chat" class="chat-window">
      {% for msg in messages %}
        {% if msg.role == 'assistant' %}
          <div class="message assistant">
            <div class="meta">Assistant</div>
            {{ msg.content | replace('\n', '<br>') | safe }}
          </div>
        {% else %}
          <div class="message user">
            <div class="meta">You</div>
            {{ msg.content | replace('\n', '<br>') | safe }}
          </div>
        {% endif %}
        <div class="clear"></div>
      {% endfor %}
    </div>

    <div class="composer">
      <input id="message-input" placeholder="Type your answer here..." autocomplete="off" />
      <button id="send-btn">Send</button>
    </div>
</div>

<script>

  // Escape HTML + newline support
  function escapeHtml(text) {
    var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
  }
  function nl2br(s) {
    return escapeHtml(s).replace(/\n/g, "<br>");
  }

  const chatEl = document.getElementById('chat');
  const input = document.getElementById('message-input');
  const btn = document.getElementById('send-btn');

  function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = 'message ' + (role === 'assistant' ? 'assistant' : 'user');

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerText = role === 'assistant' ? 'Assistant' : 'You';
    div.appendChild(meta);

    const content = document.createElement('div');
    content.innerHTML = nl2br(text);
    div.appendChild(content);

    chatEl.appendChild(div);
    chatEl.appendChild(Object.assign(document.createElement('div'), {className:'clear'}));

    chatEl.scrollTop = chatEl.scrollHeight;
  }

  btn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    appendMessage('user', msg);
    input.value = '';
    input.disabled = true;
    btn.disabled = true;

    try {
      const resp = await fetch('/chatbot-response', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: msg})
      });

      const data = await resp.json();
      appendMessage('assistant', data.reply || 'No response.');
    }
    catch (err) {
      appendMessage('assistant', 'Server error: ' + err.message);
    }
    finally {
      input.disabled = false;
      btn.disabled = false;
      input.focus();
    }
  }

  input.focus();
</script>

</body>
</html>
